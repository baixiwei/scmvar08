<!DOCTYPE html>
<html>

<head>

    <title>SCMVAR Experiment 8</title>

    <script src="jquery-1.8.3.min.js"   type="text/javascript"></script>
    <script src="jquery-ui.js"          type="text/javascript"></script>
    <link href="jquery-ui.css"          type="text/css" rel="stylesheet">
    <script src="jspsych-revised.js"    type="text/javascript"></script>
    <script src="jspsych-survey.js"     type="text/javascript"></script>
    <script src="jspsych-scmvar.js"     type="text/javascript"></script>
    <script src="utility.js"            type="text/javascript"></script>
    <script src="hallway.js"            type="text/javascript"></script>
    <script src="experiment.js"         type="text/javascript"></script>
    
    <link href="styles.css"             type="text/css" rel="stylesheet">
    
</head>

<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">

<body>
	<div id="target">
	</div>
</body>

<script type="text/javascript">

// global variables for controlling experiment settings, set below
var offline;    // boolean, determines whether database & php scripts used at all
var testing;    // boolean, determines which database is used and some other aspects of how exp runs
var mode;       // forced, free, or auto
var sections;   // indicates which experiment sections are to be included
var sim_idx;    // index of current iteration (used only for simulation of multiple subjects)
var subjid;     // subject's unique identification
var table;      // name of MySQL table where data will be stored

// experimental factors that will eventually get assigned
var condition;          // number that determines condVariation below
var subcondition;       // number that determines condVersion below
var condTestSeq;        // number in {0,1}, determines which test set is used as pretest and which as posttest
var condVariation;      // training condition, one of Nonvaried, Adaptive Varied, Yoked Varied, or Yoked Interleaved
var condVersion;        // number in {0,1,2}, determines which schema is used to begin training
var yokingSubjid;       // id of subject to whom this subject is yoked (yoked conditions only)
var yokingSeq;          // sequence of question IDs for training (yoked conditions only)

// other data that will get accessed at multiple points during the experiment
var trial_data = [];    // data recorded by jspsych during experiment trials
var pretest_accuracy;   // % correct on pretest
var start_time;         // when the experiment started

function showEntrancePage() {
    var proceed = function() {
        subjid      = "NONTURK" + Math.floor( Math.random()*1000000000 ) ;
        table       = testing ? "scmvar_08_test" : "scmvar_08";
        console.log( "index.html > setGlobalVars > offline: " + offline + "; testing: " + testing + "; mode: " + mode + "; subjid: " + subjid + "; table: " + table );
        runExperimentPart1();
    }
//    var run = ( gup('run')!=undefined ) ? gup('run') : 'normal';
    var run = ( gup('run')!="" ) ? gup('run') : 'test';
    switch ( run ) {
        case 'normal' :     // default settings for live experiment
            console.log( "index.html running live experiment." );
            offline     = false;
            testing     = false;
            mode        = "forced";
            sections    = [ "Intro", "Pretest", "Training", "Posttest", "Background" ];
            $('#target').html( entrance_nonturk );
            $("#nextPageButton").click( proceed );
            $("#nextPageButton").val( "Click Here to Start" );
            break;
        case 'test' :       // default settings for testing
            console.log( "index.html running experiment test." );
            offline     = true;
            testing     = true;
            mode        = "auto";
//            sections    = [ "Training" ];
            sections    = [ "Intro", "Pretest", "Training", "Posttest", "Background" ];
            proceed();
            break;
        case 'dashboard' :  // let the user choose
            console.log( "index.html displaying test dashboard." );
            offline     = true;
            testing     = true;
            mode        = "free";
            $('#target').html( '\
                <p><button id="full_exp_nonvaried" type="button">Full experiment, Nonvaried condition</button></p>\
                <p><button id="full_exp_adaptive"  type="button">Full experiment, Adaptive varied condition</button></p>\
                <p><button id="training_nonvaried" type="button">Training only, Nonvaried condition</button></p>\
                <p><button id="training_adaptive"  type="button">Training only, Adaptive varied condition</button></p>\
                <p><button id="simul_participant"  type="button">Simulated participant</button></p>' );
            $('#full_exp_nonvaried').click( function() {
                sections    = [ "Intro", "Pretest", "Training", "Posttest", "Background" ];
                subjid      = "NONTURK" + Math.floor( Math.random()*1000000000 ) ;
                runExperiment( { "condition": 0, "subcondition": Math.floor( Math.random()*6 ), "yokingSubjid": "", "yokingSeq": "" } );
                } );
            $('#full_exp_adaptive').click( function() {
                sections    = [ "Intro", "Pretest", "Training", "Posttest", "Background" ];
                subjid      = "NONTURK" + Math.floor( Math.random()*1000000000 ) ;
                runExperiment( { "condition": 1, "subcondition": Math.floor( Math.random()*6 ), "yokingSubjid": "", "yokingSeq": "" } );
                } );
            $('#training_nonvaried').click( function() {
                sections    = [ "Training" ];
                subjid      = "NONTURK" + Math.floor( Math.random()*1000000000 ) ;
                runExperiment( { "condition": 0, "subcondition": Math.floor( Math.random()*6 ), "yokingSubjid": "", "yokingSeq": "" } );
                } );
            $('#training_adaptive').click( function() {
                sections    = [ "Training" ];
                subjid      = "NONTURK" + Math.floor( Math.random()*1000000000 ) ;
                runExperiment( { "condition": 1, "subcondition": Math.floor( Math.random()*6 ), "yokingSubjid": "", "yokingSeq": "" } );
                } );
            $('#simul_participant').click( function() {
                offline     = false;
                testing     = true;
                mode        = "auto";
                sections    = [ "Intro", "Pretest", "Training", "Posttest", "Background" ];
                proceed(); } );
            break;
        case 'simulation' : // run many simulated participants
            if ( sim_idx==undefined ) {
                sim_idx     = 0;
            } else {
                sim_idx++;
                proceed();
            }
            console.log( "index.html running simulation, index=" + sim_idx + "." );
            offline     = false;
            testing     = true;
            mode        = "auto";
            sections    = [ "Intro", "Pretest", "Training", "Posttest", "Background" ];
            proceed();
            break;
    }
}

// introduction and pretest
function runExperimentPart1() {

    // assign testseq right away, purely random selection
    condTestSeq     = Math.floor( Math.random()*2 );

    // create experiment structure for part 1
    var exp_struct  = makeExpStructPart1( condTestSeq, sections, mode );
    console.log( "index.html > runExperimentPart1 > exp_struct length " + exp_struct.length );

    // record start time
    start_time      = new Date();
    console.log( "index.html > runExperimentPart1 > starting experiment at " + start_time.toString() );

    // run part 1, followed by parameter assignment & part 2
    jsPsych.init( $('#target'), {
        "experiment_structure": exp_struct,
        "plugins": [
            {"type": "survey", "src": "jspsych-survey.js"},
            {"type": "scmvar_test", "src": "jspsych-scmvar.js"},
            {"type": "scmvar_training", "src": "jspsych-scmvar.js"}
        ],
        "finish": function( data ) {
            // add part 1 data to trial_data
            trial_data = trial_data.concat( data );
            // calculate pretest accuracy, then go to parameter assignment & part 2
            if ( offline || sections.indexOf('Pretest')==-1 ) {
                var pretest_score = Math.floor(Math.random()*12);
                var pretest_num_trials = 12;
                pretest_accuracy = pretest_score / pretest_num_trials;
                assignParameters();
            } else {
                var pretest_score = 0, pretest_num_trials = 0;
                for ( var block_idx=0; block_idx<trial_data.length; block_idx++ ) {
                    for ( var trial_idx=0; trial_idx<trial_data[block_idx].length; trial_idx++ ) {
                        if ( trial_data[block_idx][trial_idx].section=="Pretest" ) {
                            pretest_score += trial_data[block_idx][trial_idx].accuracy;
                            pretest_num_trials += 1;
                        }
                    }
                }
                pretest_accuracy = pretest_score / pretest_num_trials;
                assignParameters();
            }
        } } ) ;
}

// parameter assignment
function assignParameters() {
    function randomAssignment() {
        condition       = Math.floor( Math.random()*2 );    // yoking is not possible offline so only non-yoked conditions are considered
        subcondition    = Math.floor( Math.random()*2 );    // determine subcondition purely randomly
        condVariation   = [ 'Nonvaried', 'Adaptive Varied', 'Yoked Varied', 'Yoked Interleaved' ][ condition ];
        condVersion     = subcondition;
        yokingSubjid    = null;
        yokingSeq       = [];        
    }
    if ( offline ) {
        console.log( "index.html > assignParameters running offline, using random assignment with restricted conditions." );
        randomAssignment();
        runExperimentPart2();
    } else {
        console.log( "index.html > assignParameters running online." );
        $.ajax({ type: 'post', cache: false, url: 'assign_parameters.php',
            data: { 'table': table, 'subjid': subjid },
            success: function(data) {
                console.log( "index.html > assignParameters > php script succeeded. output follows: " + data );
                var parameters  = $.parseJSON( data );
                condition       = parameters.condition;
                subcondition    = parameters.subcondition;
                condVariation   = [ 'Nonvaried', 'Adaptive Varied', 'Yoked Varied', 'Yoked Interleaved' ][ condition ];
                condVersion     = subcondition;
                yokingSubjid    = parameters.yokingSubjid;
                yokingSeq       = parameters.yokingSeq;
            },
            error: function(data) {
                console.log( "index.html > assignParameters > php script failed, using random assignment with restricted conditions." );
                randomAssignment();
                runExperimentPart2();
            }});
    }
}

function runExperimentPart2() {

    console.log( "index.html > runExperimentPart2 starting. condVariation: " + condVariation + "; condVersion: " + condVersion + "; yokingSeq: " + yokingSeq );

    // create experiment structure for part 2
    var exp_struct  = makeExpStructPart2( condVariation, condVersion, yokingSeq, sections, mode );
    console.log( "index.html > runExperiment > runExperimentPart2 > exp_struct length " + exp_struct.length );

    // run part 2, then save data and end the experiment
    jsPsych.init( $('#target'), {
        "experiment_structure": exp_struct,
        "plugins": [
            {"type": "survey", "src": "jspsych-survey.js"},
            {"type": "scmvar_test", "src": "jspsych-scmvar.js"},
            {"type": "scmvar_training", "src": "jspsych-scmvar.js"}
        ],
        "finish": function( data ) {
            // add new data to trial data
            trial_data = trial_data.concat( data );
            // prepend subject data to all trial data
            var end_time        = new Date();
            var total_time_min  = Number((( end_time.getTime() - start_time.getTime() ) / ( 60 * 1000 )).toFixed(2));
            var subj_data       = { "subjid": subjid, "testing": testing.toString(), "mode": mode,
                                    "condition": condition, "subcondition": subcondition,
                                    "condVariation": condVariation, "condVersion": condVersion, "condTestSeq": condTestSeq,
                                    "yokingSubjid": yokingSubjid, "yokingSeq": yokingSeq.toString(),
                                    "pretest_accuracy": pretest_accuracy,
                                    "start": start_time.toString(), "end": end_time.toString(), "time": total_time_min };
            var final_data      = prependData( subj_data, trial_data );
            // save final data to database and finish
            console.log( "index.html > runExperiment jsPsych run complete. final data follows." );
            console.log( JSON.stringify(final_data) );
            if ( offline ) {
                console.log( "index.html > runExperiment in offline mode, skipping data submission." );
                showExitPage( JSON.stringify(final_data) );
            } else {
                $.ajax( { type: 'post',
                          cache: false,
                          url: 'submit_data.php',
                          data: { 
                            'table': table,
                            'json': JSON.stringify(final_data) },
                          success: function(data) {
                            console.log( "index.html > runExperiment: submit_data succeeded." );
                            showExitPage( JSON.stringify(final_data) );
                          },
                          error: function(data) {
                            console.log( "index.html > runExperiment: submit_data failed with error " + data.statusText );
                            showExitPage( JSON.stringify(final_data) );
                          }
                        } );
            }
            
        } } ) ;
}

function prependData( subjdata, expdata ) {
    var block;
    var trial;
    var result = new Array( expdata.length );
    for ( var i=0; i<expdata.length; i++ ) {
        block = expdata[i];
        result[i] = new Array( block.length );
        for ( var j=0; j<block.length; j++ ) {
            trial = block[j];
            result[i][j] = $.extend( {},subjdata,trial );
        }
    }
    return result;
}

function showExitPage( data ) {
    if ( sim_idx!=undefined ) {
        if ( sim_idx<6 ) {
            $('#target').append( '<br>Done.')
        } else {
            showEntrancePage();
        }
    } else {
        if ( true ) {
            $('#target').html( data );
        } else {
            $('#target').html( exit_nonturk );
        }
    }
}

showEntrancePage();

</script>
</html>
